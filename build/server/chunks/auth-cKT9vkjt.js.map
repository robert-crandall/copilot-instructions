{"version":3,"file":"auth-cKT9vkjt.js","sources":["../../../.svelte-kit/adapter-node/chunks/auth.js"],"sourcesContent":["import { verify, hash } from \"@node-rs/argon2\";\nimport { nanoid } from \"nanoid\";\nimport { drizzle } from \"drizzle-orm/postgres-js\";\nimport postgres from \"postgres\";\nimport { pgTable, timestamp, text, uuid } from \"drizzle-orm/pg-core\";\nimport { d as private_env } from \"./shared-server.js\";\nimport { eq } from \"drizzle-orm\";\nconst users = pgTable(\"users\", {\n  id: uuid(\"id\").defaultRandom().primaryKey(),\n  email: text(\"email\").notNull().unique(),\n  passwordHash: text(\"password_hash\").notNull(),\n  displayName: text(\"display_name\").notNull(),\n  createdAt: timestamp(\"created_at\", { withTimezone: true }).defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\", { withTimezone: true }).defaultNow().notNull()\n});\nconst sessions = pgTable(\"sessions\", {\n  id: text(\"id\").primaryKey(),\n  userId: uuid(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  expiresAt: timestamp(\"expires_at\", { withTimezone: true }).notNull(),\n  createdAt: timestamp(\"created_at\", { withTimezone: true }).defaultNow().notNull()\n});\nconst content = pgTable(\"content\", {\n  id: uuid(\"id\").defaultRandom().primaryKey(),\n  userId: uuid(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  title: text(\"title\").notNull(),\n  content: text(\"content\").notNull(),\n  createdAt: timestamp(\"created_at\", { withTimezone: true }).defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\", { withTimezone: true }).defaultNow().notNull()\n});\nconst schema = /* @__PURE__ */ Object.freeze(/* @__PURE__ */ Object.defineProperty({\n  __proto__: null,\n  content,\n  sessions,\n  users\n}, Symbol.toStringTag, { value: \"Module\" }));\nif (!private_env.DATABASE_URL) throw new Error(\"DATABASE_URL is not set\");\nconst client = postgres(private_env.DATABASE_URL);\nconst db = drizzle(client, { schema });\nconst SESSION_DURATION = 1e3 * 60 * 60 * 24 * 30;\nasync function hashPassword(password) {\n  return await hash(password, {\n    memoryCost: 19456,\n    timeCost: 2,\n    outputLen: 32,\n    parallelism: 1\n  });\n}\nasync function verifyPassword(hash2, password) {\n  return await verify(hash2, password);\n}\nasync function createSession(userId) {\n  const sessionId = nanoid();\n  const expiresAt = new Date(Date.now() + SESSION_DURATION);\n  await db.insert(sessions).values({\n    id: sessionId,\n    userId,\n    expiresAt\n  });\n  return sessionId;\n}\nasync function validateSession(sessionId) {\n  const result = await db.select({\n    user: users,\n    session: sessions\n  }).from(sessions).innerJoin(users, eq(sessions.userId, users.id)).where(eq(sessions.id, sessionId)).limit(1);\n  if (result.length === 0) {\n    return null;\n  }\n  const { user, session } = result[0];\n  if (session.expiresAt < /* @__PURE__ */ new Date()) {\n    await deleteSession(sessionId);\n    return null;\n  }\n  return { user, session };\n}\nasync function deleteSession(sessionId) {\n  await db.delete(sessions).where(eq(sessions.id, sessionId));\n}\nasync function createUser(email, password, displayName) {\n  const passwordHash = await hashPassword(password);\n  const result = await db.insert(users).values({\n    email,\n    passwordHash,\n    displayName\n  }).returning();\n  return result[0];\n}\nasync function getUserByEmail(email) {\n  const result = await db.select().from(users).where(eq(users.email, email)).limit(1);\n  return result.length > 0 ? result[0] : null;\n}\nasync function authenticateUser(email, password) {\n  const user = await getUserByEmail(email);\n  if (!user) {\n    return null;\n  }\n  const isValidPassword = await verifyPassword(user.passwordHash, password);\n  if (!isValidPassword) {\n    return null;\n  }\n  return user;\n}\nexport {\n  authenticateUser as a,\n  createUser as b,\n  createSession as c,\n  deleteSession as d,\n  getUserByEmail as g,\n  validateSession as v\n};\n"],"names":[],"mappings":"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"}